name: build

on:
  pull_request:
  push:
    branches:
      - '**'
    tags:
      - '*'

jobs:
  dist:
    name: build-and-package (${{ matrix.display }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - display: ubuntu-x86_64
            runner: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            archive_os: ubuntu
            archive_arch: x86_64
            exe_suffix: ""
            shell: bash
          - display: ubuntu-arm64
            runner: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            archive_os: ubuntu
            archive_arch: arm64
            exe_suffix: ""
            shell: bash
          - display: windows-x86_64
            runner: windows-latest
            target: x86_64-pc-windows-msvc
            archive_os: windows
            archive_arch: x86_64
            exe_suffix: ".exe"
            shell: bash
    env:
      CARGO_TERM_COLOR: always
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Determine version
        id: version
        shell: ${{ matrix.shell }}
        run: |
          set -euo pipefail
          ref_type="${GITHUB_REF_TYPE:-}"
          if [[ -z "$ref_type" ]]; then
            if [[ "${GITHUB_REF:-}" == refs/tags/* ]]; then
              ref_type="tag"
            else
              ref_type="branch"
            fi
          fi
          ref_name="${GITHUB_REF_NAME:-}"
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            ref_name="${GITHUB_HEAD_REF:-$ref_name}"
          fi
          if [[ -z "$ref_name" ]]; then
            ref_name="detached"
          fi
          if [[ "$ref_type" == "tag" ]]; then
            version="$ref_name"
          else
            sanitized=$(echo "$ref_name" | sed 's/[^A-Za-z0-9._-]/-/g')
            sha="${GITHUB_SHA::7}"
            version="${sanitized}-${sha}"
          fi
          echo "version=$version" >> "$GITHUB_OUTPUT"
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly
        with:
          targets: ${{ matrix.target }}
      - name: Cargo build
        shell: ${{ matrix.shell }}
        run: |
          set -euo pipefail
          cargo -Znext-lockfile-bump build --release --bins
      - name: Package binaries
        id: package
        if: github.event_name == 'push'
        shell: ${{ matrix.shell }}
        run: |
          set -euo pipefail
          version="${{ steps.version.outputs.version }}"
          archive_os="${{ matrix.archive_os }}"
          archive_arch="${{ matrix.archive_arch }}"
          archive="lpc55_support-${version}-${archive_os}-${archive_arch}"
          staging="dist/${archive}"
          exe_suffix="${{ matrix.exe_suffix }}"
          mkdir -p "${staging}/bin"
          cp "target/release/lpc55_sign${exe_suffix}" "${staging}/bin/"
          cp "target/release/lpc55_flash${exe_suffix}" "${staging}/bin/"
          cp "target/release/cfpa-update${exe_suffix}" "${staging}/bin/"
          cp README.md "${staging}/"
          tar -czf "${archive}.tar.gz" -C dist "${archive}"
          echo "archive_name=${archive}.tar.gz" >> "$GITHUB_OUTPUT"
          echo "archive_path=${archive}.tar.gz" >> "$GITHUB_OUTPUT"
      - name: Upload archive
        if: github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.archive_name }}
          path: ${{ steps.package.outputs.archive_path }}

  publish:
    needs: dist
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Determine version
        id: version
        run: |
          set -euo pipefail
          ref_type="${GITHUB_REF_TYPE:-}"
          if [[ -z "$ref_type" ]]; then
            if [[ "${GITHUB_REF:-}" == refs/tags/* ]]; then
              ref_type="tag"
            else
              ref_type="branch"
            fi
          fi
          ref_name="${GITHUB_REF_NAME:-}"
          if [[ -z "$ref_name" ]]; then
            ref_name="detached"
          fi
          if [[ "$ref_type" == "tag" ]]; then
            version="$ref_name"
            prerelease=false
          else
            sanitized=$(echo "$ref_name" | sed 's/[^A-Za-z0-9._-]/-/g')
            sha="${GITHUB_SHA::7}"
            version="${sanitized}-${sha}"
            prerelease=true
          fi
          {
            echo "version=$version"
            echo "prerelease=$prerelease"
          } >> "$GITHUB_OUTPUT"
      - name: Download archives
        uses: actions/download-artifact@v4
        with:
          path: release
      - name: Gather files
        id: gather
        run: |
          set -euo pipefail
          shopt -s nullglob globstar
          files=(release/**/*.tar.gz)
          if (( ${#files[@]} == 0 )); then
            echo "No archives found" >&2
            exit 1
          fi
          {
            echo "list<<EOF"
            printf '%s\n' "${files[@]}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: lpc55_support ${{ steps.version.outputs.version }}
          target_commitish: ${{ github.sha }}
          prerelease: ${{ steps.version.outputs.prerelease }}
          files: ${{ steps.gather.outputs.list }}
          draft: false
          allow_updates: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
